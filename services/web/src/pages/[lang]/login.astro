---
import Base from '../../layouts/Base.astro';
import Topbar from '../../components/Topbar.astro';
import { proxyToPortal } from '../../lib/proxy';
import { isLocale, type Locale } from '../../i18n/config';
import { t, localePath } from '../../i18n/utils';

const { lang } = Astro.params;
if (!lang || !isLocale(lang)) return Astro.redirect('/en/login', 302);
const locale = lang as Locale;

// Handle POST in frontmatter — returning a Response short-circuits the
// template rendering, so the portal's 303 redirect reaches the browser.
// The exported POST function below is still required: Astro 5's Node adapter
// rejects POST on .astro pages that don't export POST (405 before middleware).
if (Astro.request.method === 'POST') {
  // Proxy to the portal's /login endpoint (not locale-prefixed).
  // The portal redirects to /dashboard on success — we rewrite that to /{locale}/dashboard.
  const resp = await proxyToPortal(Astro.request, '/login');

  // Rewrite portal redirects to locale-prefixed paths.
  if (resp.status >= 300 && resp.status < 400) {
    const location = resp.headers.get('Location') || '';
    if (location === '/dashboard' || location.endsWith('/dashboard')) {
      return new Response(null, {
        status: resp.status,
        headers: { ...Object.fromEntries(resp.headers), Location: localePath(locale, '/dashboard') },
      });
    }
    // Rewrite error redirects back to locale-prefixed login.
    if (location.startsWith('/login')) {
      const search = location.includes('?') ? location.substring(location.indexOf('?')) : '';
      return new Response(null, {
        status: resp.status,
        headers: { ...Object.fromEntries(resp.headers), Location: localePath(locale, '/login') + search },
      });
    }
  }
  return resp;
}

export function POST() {
  // Never reached — frontmatter return above handles all POSTs.
  // Exists solely to tell Astro this page accepts POST.
  return new Response(null, { status: 204 });
}

const error = Astro.url.searchParams.get('error') || '';
---

<Base title={t(locale, 'login.title')} lang={locale}>
    <Topbar slot="topbar" locale={locale} />

    <section class="auth-page">
        <div class="auth-container">
            <h1 class="title is-4 has-text-centered" style="font-family: 'Montserrat', sans-serif;">{t(locale, 'login.heading')}</h1>
            <p class="subtitle is-6 is-muted has-text-centered mb-5">{t(locale, 'login.subtitle')}</p>

            <div class="box auth-card">
                {error && (
                    <div class="notification is-danger is-light">
                        <span class="icon"><i class="fas fa-exclamation-circle"></i></span>
                        {error}
                    </div>
                )}
                <form action={localePath(locale, '/login')} method="POST">
                    <div class="field">
                        <label class="label" for="email" style="font-size: 0.9rem;">{t(locale, 'login.emailLabel')}</label>
                        <div class="control has-icons-left">
                            <input class="input" type="email" id="email" name="email" placeholder={t(locale, 'login.emailPlaceholder')} required>
                            <span class="icon is-small is-left" style="color: var(--fresh-muted);"><i class="fas fa-envelope"></i></span>
                        </div>
                    </div>
                    <div class="field">
                        <label class="label" for="password" style="font-size: 0.9rem;">{t(locale, 'login.passwordLabel')}</label>
                        <div class="control has-icons-left">
                            <input class="input" type="password" id="password" name="password" required>
                            <span class="icon is-small is-left" style="color: var(--fresh-muted);"><i class="fas fa-lock"></i></span>
                        </div>
                    </div>
                    <div class="field mt-5">
                        <button class="button primary-btn is-rounded is-fullwidth cta" type="submit">
                            {t(locale, 'login.submit')}
                        </button>
                    </div>
                </form>
            </div>
            <p class="has-text-centered has-text-fresh-muted mt-4" style="font-size: 0.9rem;">
                {t(locale, 'login.noAccount')} <a href={localePath(locale, '/signup')} style="color: var(--fresh-primary);">{t(locale, 'login.signupLink')}</a>
            </p>
        </div>
    </section>
</Base>

<style>
    .auth-page {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: calc(100vh - 52px); /* subtract topbar */
        padding: 2rem 1rem;
    }
    .auth-container {
        width: 100%;
        max-width: 380px;
    }
</style>
